<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEXUS | The Next Gen Interface</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        nexus: {
                            dark: '#0a0a0c',
                            panel: '#131316',
                            border: '#2d2d33',
                            accent: '#3b82f6',
                            glass: 'rgba(19, 19, 22, 0.7)',
                        }
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'fade-in-up': 'fadeInUp 0.5s ease-out forwards',
                    },
                    keyframes: {
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #000000;
            background-image: 
                radial-gradient(at 0% 0%, rgba(59, 130, 246, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(139, 92, 246, 0.15) 0px, transparent 50%);
            color: #e4e4e7;
        }
        
        .glass-panel {
            background: var(--nexus-glass);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Markdown Content Styling */
        .prose p { margin-bottom: 0.8em; }
        .prose ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 0.8em; }
        .prose ol { list-style-type: decimal; padding-left: 1.5em; margin-bottom: 0.8em; }
        .prose code { background: rgba(255,255,255,0.1); padding: 2px 4px; border-radius: 4px; font-family: 'JetBrains Mono'; font-size: 0.9em; }
        .prose pre { background: #1a1a1a; padding: 1em; border-radius: 8px; overflow-x: auto; margin-bottom: 1em; border: 1px solid #333; }
        .prose pre code { background: transparent; padding: 0; }
        .prose h1, .prose h2, .prose h3 { font-weight: 600; color: #fff; margin-top: 1em; margin-bottom: 0.5em; }
        
        /* Mic Pulse Animation */
        .mic-active {
            box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
            animation: pulse-blue 1.5s infinite;
            background-color: #ef4444 !important; /* Red when recording */
        }
        
        @keyframes pulse-blue {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 15px rgba(59, 130, 246, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }

        /* Typing indicator */
        .typing-dot {
            animation: typing 1.4s infinite ease-in-out both;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        .model-btn-active {
            background-color: rgba(37, 99, 235, 0.2);
            color: #60a5fa;
            border-color: rgba(59, 130, 246, 0.3);
        }
        
        .model-btn-inactive {
            color: #9ca3af;
            border-color: transparent;
        }
        .model-btn-inactive:hover {
            color: #ffffff;
        }
    </style>
</head>
<body class="h-screen w-screen flex flex-col overflow-hidden font-sans selection:bg-blue-500 selection:text-white">

    <!-- Header / Toolbar -->
    <header class="h-14 glass-panel flex items-center justify-between px-6 z-50 shrink-0">
        <div class="flex items-center gap-3">
            <div class="w-3 h-3 rounded-full bg-blue-500 shadow-[0_0_10px_rgba(59,130,246,0.5)]"></div>
            <span class="font-bold tracking-wider text-lg">NEXUS <span class="text-xs font-normal text-gray-400 ml-1 opacity-75">OS v1.0</span></span>
        </div>

        <!-- Model Selector -->
        <div class="hidden md:flex items-center gap-2 bg-black/30 rounded-full p-1 border border-white/5">
            <button id="btn-god-mode" onclick="setModel('god')" class="px-4 py-1.5 rounded-full text-xs font-medium border transition model-btn-inactive">
                <i class="fa-solid fa-bolt mr-1"></i> God Mode (Gemini 3.0)
            </button>
            <button id="btn-standard" onclick="setModel('standard')" class="px-4 py-1.5 rounded-full text-xs font-medium border transition model-btn-active">
                Standard (Flash 2.5)
            </button>
        </div>

        <div class="flex items-center gap-4">
            <button onclick="toggleSettings()" class="text-gray-400 hover:text-white transition">
                <i class="fa-solid fa-gear"></i>
            </button>
        </div>
    </header>

    <!-- Main Workspace -->
    <div class="flex-1 flex overflow-hidden relative">
        
        <!-- Chat Interface (Left) -->
        <div id="chat-panel" class="w-full md:w-1/2 flex flex-col border-r border-white/5 bg-black/20 relative transition-all duration-300">
            
            <!-- Messages Area -->
            <div id="messages" class="flex-1 overflow-y-auto p-6 space-y-6 scrollbar-hide pb-32">
                
                <!-- Welcome Message -->
                <div class="flex gap-4 animate-fade-in-up">
                    <div class="w-8 h-8 rounded-lg bg-blue-600/20 border border-blue-500/30 flex items-center justify-center shrink-0 text-blue-400">
                        <i class="fa-solid fa-robot text-sm"></i>
                    </div>
                    <div class="flex flex-col gap-1 max-w-[85%]">
                        <span class="text-xs text-gray-500 font-mono">NEXUS AI</span>
                        <div class="text-sm text-gray-200 leading-relaxed prose">
                            <p>System Online. API endpoints updated to 2025 standards.</p>
                            <p>Try: <em>"Build a scientific calculator app"</em> or <em>"Create a Space Invaders game"</em>.</p>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Input Area -->
            <div class="absolute bottom-0 left-0 w-full p-6 bg-gradient-to-t from-black via-black/90 to-transparent z-10">
                <div class="relative glass-panel rounded-2xl p-2 flex items-end gap-2 transition-all duration-200 focus-within:border-blue-500/50 shadow-2xl">
                    
                    <!-- Voice Button -->
                    <button id="mic-btn" class="w-10 h-10 rounded-xl bg-gray-800 hover:bg-gray-700 text-gray-400 hover:text-white flex items-center justify-center transition-all shrink-0">
                        <i class="fa-solid fa-microphone"></i>
                    </button>

                    <!-- Text Input -->
                    <textarea id="user-input" rows="1" class="w-full bg-transparent border-none text-white placeholder-gray-500 focus:ring-0 text-sm py-3 max-h-32 resize-none" placeholder="Describe the app you want to build..."></textarea>

                    <!-- Send Button -->
                    <button id="send-btn" class="w-10 h-10 rounded-xl bg-blue-600 hover:bg-blue-500 text-white flex items-center justify-center shadow-[0_0_15px_rgba(37,99,235,0.3)] transition-all shrink-0">
                        <i class="fa-solid fa-paper-plane text-sm"></i>
                    </button>
                </div>
                <div class="text-center mt-2">
                    <span id="model-status" class="text-[10px] text-gray-600 uppercase tracking-widest font-mono">Standard Mode • Gemini 2.5 Flash</span>
                </div>
            </div>
        </div>

        <!-- Preview/App Panel (Right) -->
        <div id="preview-panel" class="hidden md:flex flex-1 flex-col bg-[#050505] relative">
            <!-- Preview Header -->
            <div class="h-10 border-b border-white/5 flex items-center justify-between px-4 bg-[#0a0a0c]">
                <span class="text-xs font-mono text-gray-400 flex items-center gap-2">
                    <i class="fa-solid fa-code text-blue-500"></i> LIVE PREVIEW
                </span>
                <div class="flex gap-2">
                    <button onclick="toggleFullscreenPreview()" class="text-gray-500 hover:text-white text-xs"><i class="fa-solid fa-expand"></i></button>
                    <button onclick="reloadPreview()" class="text-gray-500 hover:text-white text-xs"><i class="fa-solid fa-rotate-right"></i></button>
                </div>
            </div>

            <!-- Iframe Container -->
            <div class="flex-1 relative w-full h-full bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] bg-opacity-5">
                <div id="empty-state" class="absolute inset-0 flex flex-col items-center justify-center text-gray-600">
                    <i class="fa-solid fa-cube text-4xl mb-4 opacity-20"></i>
                    <p class="text-sm font-mono opacity-50">Waiting for code generation...</p>
                </div>
                <iframe id="app-frame" class="w-full h-full border-none bg-white hidden" sandbox="allow-scripts allow-forms allow-modals"></iframe>
            </div>
        </div>

    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] hidden flex items-center justify-center">
        <div class="glass-panel w-96 p-6 rounded-2xl shadow-2xl border border-gray-800">
            <h2 class="text-lg font-bold mb-4 flex items-center gap-2"><i class="fa-solid fa-key text-blue-500"></i> Configuration</h2>
            <p class="text-xs text-gray-400 mb-4">To power this interface, please provide a Gemini API Key. The key is stored only in your browser's memory.</p>
            
            <label class="block text-xs font-mono text-gray-500 mb-1">GEMINI API KEY</label>
            <input type="password" id="api-key-input" class="w-full bg-black/50 border border-gray-700 rounded-lg p-2 text-sm text-white focus:border-blue-500 focus:outline-none mb-4" placeholder="AIzaSy...">
            
            <div class="flex justify-end gap-2">
                <button onclick="toggleSettings()" class="px-4 py-2 rounded-lg text-xs font-medium text-gray-400 hover:bg-white/5 transition">Cancel</button>
                <button onclick="saveSettings()" class="px-4 py-2 rounded-lg text-xs font-medium bg-blue-600 text-white hover:bg-blue-500 transition shadow-lg">Connect System</button>
            </div>
        </div>
    </div>

    <script>
        // --- State & DOM ---
        let apiKey = "";
        let isRecording = false;
        let recognition = null;
        let currentModel = "gemini-2.5-flash"; // Default to newer Flash model
        
        const messagesDiv = document.getElementById('messages');
        const userInput = document.getElementById('user-input');
        const appFrame = document.getElementById('app-frame');
        const emptyState = document.getElementById('empty-state');
        const micBtn = document.getElementById('mic-btn');
        const modelStatus = document.getElementById('model-status');

        // --- Initialization ---
        window.onload = () => {
            // Auto-resize textarea
            userInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });

            // Enter to send
            userInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            document.getElementById('send-btn').onclick = sendMessage;
            document.getElementById('mic-btn').onclick = toggleVoice;
            
            // Check for basic speech support
            if ('webkitSpeechRecognition' in window) {
                recognition = new webkitSpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;

                recognition.onresult = (event) => {
                    const text = event.results[0][0].transcript;
                    userInput.value = text;
                    toggleVoice(); // Stop recording animation
                    sendMessage(); 
                };

                recognition.onerror = (event) => {
                    console.error("Speech error", event);
                    toggleVoice();
                };
                
                recognition.onend = () => {
                    if(isRecording) toggleVoice();
                };
            } else {
                micBtn.style.display = 'none';
            }
        };

        // --- UI Functions ---
        function toggleSettings() {
            const modal = document.getElementById('settings-modal');
            modal.classList.toggle('hidden');
        }

        function saveSettings() {
            const input = document.getElementById('api-key-input');
            if(input.value.trim()) {
                apiKey = input.value.trim();
                const btn = document.querySelector('#settings-modal button:last-child');
                btn.innerHTML = '<i class="fa-solid fa-check"></i> Connected';
                btn.classList.remove('bg-blue-600');
                btn.classList.add('bg-green-600');
                setTimeout(() => {
                    toggleSettings();
                    addSystemMessage("System connected. Ready.");
                }, 1000);
            }
        }

        function setModel(mode) {
            const btnGod = document.getElementById('btn-god-mode');
            const btnStd = document.getElementById('btn-standard');

            if (mode === 'god') {
                currentModel = "gemini-3.0-pro-preview"; // High reasoning model
                btnGod.classList.remove('model-btn-inactive');
                btnGod.classList.add('model-btn-active');
                btnStd.classList.remove('model-btn-active');
                btnStd.classList.add('model-btn-inactive');
                modelStatus.innerText = "GOD MODE ACTIVE • GEMINI 3.0 PRO";
                modelStatus.classList.add('text-blue-400');
            } else {
                currentModel = "gemini-2.5-flash"; // Standard fast model
                btnStd.classList.remove('model-btn-inactive');
                btnStd.classList.add('model-btn-active');
                btnGod.classList.remove('model-btn-active');
                btnGod.classList.add('model-btn-inactive');
                modelStatus.innerText = "STANDARD MODE • GEMINI 2.5 FLASH";
                modelStatus.classList.remove('text-blue-400');
            }
        }

        function toggleVoice() {
            if (!recognition) return;
            
            if (isRecording) {
                recognition.stop();
                micBtn.classList.remove('mic-active');
                isRecording = false;
            } else {
                recognition.start();
                micBtn.classList.add('mic-active');
                isRecording = true;
            }
        }

        function appendUserMessage(text) {
            const div = document.createElement('div');
            div.className = "flex gap-4 flex-row-reverse animate-fade-in-up";
            div.innerHTML = `
                <div class="w-8 h-8 rounded-lg bg-white/10 flex items-center justify-center shrink-0 text-white">
                    <i class="fa-solid fa-user text-sm"></i>
                </div>
                <div class="flex flex-col gap-1 items-end max-w-[85%]">
                    <div class="bg-blue-600 text-white px-4 py-2 rounded-2xl rounded-tr-sm text-sm leading-relaxed shadow-lg">
                        ${text.replace(/\n/g, '<br>')}
                    </div>
                </div>
            `;
            messagesDiv.appendChild(div);
            scrollToBottom();
        }

        function appendAIMessage(text, isTyping = false) {
            const id = 'msg-' + Date.now();
            const div = document.createElement('div');
            div.className = "flex gap-4 animate-fade-in-up";
            div.innerHTML = `
                <div class="w-8 h-8 rounded-lg bg-blue-600/20 border border-blue-500/30 flex items-center justify-center shrink-0 text-blue-400">
                    <i class="fa-solid fa-robot text-sm"></i>
                </div>
                <div class="flex flex-col gap-1 max-w-[85%]">
                    <span class="text-xs text-gray-500 font-mono">NEXUS AI (${currentModel})</span>
                    <div id="${id}" class="text-sm text-gray-200 leading-relaxed prose">
                        ${isTyping ? '<div class="flex gap-1 h-5 items-center"><div class="w-1.5 h-1.5 bg-gray-500 rounded-full typing-dot"></div><div class="w-1.5 h-1.5 bg-gray-500 rounded-full typing-dot"></div><div class="w-1.5 h-1.5 bg-gray-500 rounded-full typing-dot"></div></div>' : formatText(text)}
                    </div>
                </div>
            `;
            messagesDiv.appendChild(div);
            scrollToBottom();
            return id;
        }

        function addSystemMessage(text) {
            const div = document.createElement('div');
            div.className = "flex justify-center my-4 opacity-50";
            div.innerHTML = `<span class="text-[10px] font-mono bg-white/5 px-2 py-1 rounded text-gray-400 border border-white/5">${text}</span>`;
            messagesDiv.appendChild(div);
            scrollToBottom();
        }

        function scrollToBottom() {
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // --- Logic & API ---
        async function sendMessage() {
            const text = userInput.value.trim();
            if (!text) return;

            userInput.value = '';
            userInput.style.height = 'auto';
            appendUserMessage(text);

            if (!apiKey) {
                setTimeout(() => appendAIMessage("Please configure your API Key in settings (Top Right Gear Icon)."), 500);
                return;
            }

            const msgId = appendAIMessage("", true); // Show typing
            
            try {
                const responseText = await callGemini(text);
                const msgEl = document.getElementById(msgId);
                msgEl.innerHTML = formatText(responseText);

                // Speak response (optional)
                if(!responseText.includes("```")) {
                    speak(responseText.substring(0, 200));
                } else {
                    speak("I've generated the code for you.");
                }

                extractAndRenderCode(responseText);

            } catch (err) {
                document.getElementById(msgId).innerHTML = `<span class="text-red-400">Error: ${err.message}. Try switching models.</span>`;
            }
        }

        async function callGemini(prompt) {
            // Dynamic URL based on selected model
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${currentModel}:generateContent?key=${apiKey}`;
            
            const systemPrompt = "You are NEXUS, a highly advanced AI interface designed to build web applications. Your output should be helpful and concise. If the user asks to build an app, game, or tool, you MUST provide the complete, self-contained HTML/CSS/JS code within a single ```html code block. Do not use external CSS/JS files unless using CDNs like Tailwind or FontAwesome. Make the design modern, dark-mode by default, and beautiful. Focus on high-quality UI.";

            const payload = {
                contents: [{
                    parts: [{ text: systemPrompt + "\n\nUser Request: " + prompt }]
                }]
            };

            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const data = await res.json();
            
            if (data.error) {
                // Fallback logic if God Mode (Preview) fails, try Flash
                if (data.error.code === 404 && currentModel.includes('3.0')) {
                    console.warn("Gemini 3.0 Preview not found/access denied. Falling back to 2.5 Flash.");
                    currentModel = "gemini-2.5-flash";
                    addSystemMessage("Model fallback: Switching to Gemini 2.5 Flash");
                    return callGemini(prompt); // Retry
                }
                throw new Error(data.error.message);
            }
            return data.candidates[0].content.parts[0].text;
        }

        // --- Code Extraction & Rendering ---
        function extractAndRenderCode(text) {
            // Regex to find ```html ... ``` blocks
            const htmlMatch = text.match(/```html([\s\S]*?)```/);
            
            if (htmlMatch && htmlMatch[1]) {
                const code = htmlMatch[1].trim();
                
                emptyState.classList.add('hidden');
                appFrame.classList.remove('hidden');
                appFrame.srcdoc = code;
                
                addSystemMessage("Compiling Application... Rendering Preview");
            }
        }

        function formatText(text) {
            let html = text
                .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n/g, '<br>');
            return html;
        }

        function speak(text) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 1.1;
                utterance.pitch = 1;
                window.speechSynthesis.speak(utterance);
            }
        }

        function reloadPreview() {
            if(appFrame.srcdoc) appFrame.srcdoc = appFrame.srcdoc;
        }

        function toggleFullscreenPreview() {
            const panel = document.getElementById('preview-panel');
            const chat = document.getElementById('chat-panel');
            
            if (chat.style.display === 'none') {
                chat.style.display = 'flex';
                panel.classList.remove('absolute', 'inset-0', 'z-40');
            } else {
                chat.style.display = 'none';
                panel.classList.add('absolute', 'inset-0', 'z-40');
            }
        }

    </script>
</body>
</html>
